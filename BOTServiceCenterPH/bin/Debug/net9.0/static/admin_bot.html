<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Chatbot Pizza Hut - Admin</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="icon" type="image/png" href="../static/favicon.ico">

  <!--<script>
    const currentHost = window.location.hostname;
    if (currentHost !== "www.servicecenterph.com") {
      window.location.href = "https://www.servicecenterph.com";
    }
  </script>-->

  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', sans-serif;
      background: url('../static/Resourses/Image/Fondo.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      color: #f0f0f0;
    }

    .container {
      margin-top: 100px;
      width: 95%;
      max-width: 600px;
      background: rgba(0, 0, 0, 0.90);
      border-radius: 16px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.6);
      overflow: hidden;
    }

    .chat-header {
      background-color: #ff0000;
      text-align: center;
      padding: 16px;
      font-size: 1.5rem;
      font-weight: bold;
      border-bottom: 2px solid #b71c1c;
    }

    #chatbox {
      max-height: 400px;
      overflow-y: auto;
      padding: 20px;
      background-color: #121212;
    }

    .message {
      display: flex;
      margin-bottom: 12px;
    }

    .message.user {
      justify-content: flex-end;
    }

    .message.bot {
      justify-content: flex-start;
    }

    .bubble {
      padding: 12px 16px;
      border-radius: 20px;
      max-width: 75%;
      line-height: 1.4;
      font-size: 0.95rem;
    }

    .message.user .bubble {
      background-color: #0d47a1;
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .message.bot .bubble {
      background-color: #2e7d32;
      color: #fff;
      border-bottom-left-radius: 4px;
    }

    .input-area {
      display: flex;
      padding: 12px;
      background-color: #1a1a1a;
    }

    #userInput {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 20px 0 0 20px;
      outline: none;
    }

    #sendBtn {
      padding: 10px 20px;
      background-color: #e53935;
      border: none;
      border-radius: 0 20px 20px 0;
      color: #fff;
      cursor: pointer;
      transition: background 0.3s;
    }

    #sendBtn:hover {
      background-color: #c62828;
    }

    .loader {
      margin-left: 12px;
      width: 20px;
      height: 20px;
      border: 3px solid #ccc;
      border-top: 3px solid #ff0000;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .suggestions {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .suggestion {
      background-color: #444;
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      cursor: pointer;
    }

    .suggestion:hover {
      background-color: #666;
    }

    table {
      margin-top: 30px;
      width: 95%;
      max-width: 600px;
      background-color: rgba(0, 0, 0, 0.85);
      border-collapse: collapse;
      color: #fff;
      border-radius: 8px;
      overflow: hidden;
    }

    th,
    td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #444;
    }

    th {
      background-color: #d32f2f;
    }

    .delete-btn {
      background-color: #d32f2f;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .delete-btn:hover {
      background-color: #b71c1c;
    }

    .download-btn {
      background-color: green;
      border: none;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
    }

    .download-btn:hover {
      background-color: rgb(0, 163, 0);
    }

    form {
      background: rgba(0, 0, 0, 0.85);
      padding: 16px;
      border-radius: 12px;
      margin-top: 20px;
      width: 95%;
      max-width: 600px;
      color: white;
    }

    form input[type="file"] {
      display: block;
      margin-bottom: 12px;
    }

    form button {
      background-color: #4caf50;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }

    form button:hover {
      background-color: #388e3c;
    }

    .ticket-btn {
      margin-top: 12px;
      background-color: #ff9800;
      color: white;
      padding: 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .ticket-form {
      margin-top: 10px;
      background: #212121;
      border-radius: 10px;
      padding: 12px;
      color: white;
    }

    .ticket-form input {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: none;
    }

    .ticket-form button {
      background-color: #e53935;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }

    .ticket-form button:hover {
      background-color: #c62828;
    }
  </style>
</head>

<body>

  <div class="container">
    <div class="chat-header">
      <img src="/static/Resourses/Image/logo.png" alt="Logo"
        style="height: 70px; vertical-align: middle; margin-right: -20px;">
      Chatbot Pizza Hut
    </div>

    <div id="chatbox"></div>
    <div class="input-area">
      <input type="text" id="userInput" placeholder="Escribe tu pregunta..." autocomplete="off" />
      <button id="sendBtn">Enviar</button>
      <div id="loader" class="loader" style="display:none;"></div>
    </div>
  </div>

  <h2>Archivos CSV Disponibles</h2>
  <table aria-label="Lista de archivos CSV">
    <thead>
      <tr>
        <th>Nombre del archivo</th>
        <th>Acciones</th>
      </tr>
    </thead>
    <tbody id="csvTableBody">
      <!-- Aquí se insertan filas -->
    </tbody>
  </table>

  <form id="uploadForm" enctype="multipart/form-data">
    <label for="csvFile">Subir nuevo CSV:</label>
    <input type="file" id="csvFile" name="csvFile" accept=".csv" required />
    <button type="submit">Subir</button>
  </form>

  <script>
    // Funciones para chatbot (igual que las tuyas)
    const chatbox = document.getElementById('chatbox');
    const input = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const loader = document.getElementById('loader');

    sendBtn.addEventListener('click', () => sendMessage());
    input.addEventListener('keypress', e => {
      if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage(preguntaSug = null) {
      const text = preguntaSug || input.value.trim();
      if (!text) return;

      appendMessage('user', text);
      input.value = '';
      loader.style.display = 'inline-block';
      chatbox.scrollTop = chatbox.scrollHeight;

      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text })
        });
        const data = await res.json();
        appendMessage('bot', data.response, data.suggestions, data.ticket_option || false, data.titulo_sugerido || "");
      } catch {
        appendMessage('bot', 'Error: no se pudo conectar con el servidor.');
      } finally {
        loader.style.display = 'none';
        chatbox.scrollTop = chatbox.scrollHeight;
      }
    }

    function appendMessage(sender, text, suggestions = []) {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + sender;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      msgDiv.appendChild(bubble);
      chatbox.appendChild(msgDiv);

      if (sender === 'bot' && suggestions.length > 0) {
        const sugContainer = document.createElement('div');
        sugContainer.className = 'suggestions';
        suggestions.forEach(s => {
          const btn = document.createElement('div');
          btn.className = 'suggestion';
          btn.textContent = s;
          btn.onclick = () => sendMessage(s);
          sugContainer.appendChild(btn);
        });
        chatbox.appendChild(sugContainer);
      }
    }

    // Funciones para listar y borrar CSVs
    const csvTableBody = document.getElementById('csvTableBody');

    async function loadCSVList() {
      try {
        const res = await fetch('/available_csvs');
        const csvs = await res.json();
        csvTableBody.innerHTML = '';

        if (!csvs.length) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 3;
          td.textContent = 'No hay archivos CSV disponibles.';
          tr.appendChild(td);
          csvTableBody.appendChild(tr);
          return;
        }

        csvs.forEach(filename => {
          const tr = document.createElement('tr');

          const tdName = document.createElement('td');
          tdName.textContent = filename;
          tr.appendChild(tdName);

          const tdActions = document.createElement('td');

          // Botón Descargar
          const btnDownload = document.createElement('button');
          btnDownload.className = 'download-btn';
          btnDownload.textContent = 'Descargar';
          btnDownload.onclick = () => {
            downloadCSV(filename);
          };
          tdActions.appendChild(btnDownload);

          // Botón Borrar
          const btnDelete = document.createElement('button');
          btnDelete.className = 'delete-btn';
          btnDelete.textContent = 'Borrar';
          btnDelete.style.marginLeft = '10px';
          btnDelete.onclick = () => {
            if (confirm(`¿Seguro que deseas borrar "${filename}"? Esta acción no se puede deshacer.`)) {
              deleteCSV(filename);
            }
          };
          tdActions.appendChild(btnDelete);

          tr.appendChild(tdActions);
          csvTableBody.appendChild(tr);
        });
      } catch (err) {
        alert('Error cargando la lista de CSVs: ' + err);
      }
    }

    function downloadCSV(filename) {
      const link = document.createElement('a');
      link.href = `/download_csv/${encodeURIComponent(filename)}`;
      link.download = filename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    async function deleteCSV(filename) {
      try {
        const res = await fetch('/delete_csv', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename })
        });

        const text = await res.text();
        try {
          const data = JSON.parse(text);
          if (data.success) {
            alert(`Archivo "${filename}" borrado correctamente.`);
            loadCSVList();
          } else {
            alert('Error al borrar archivo: ' + (data.error || 'Desconocido'));
          }
        } catch {
          alert('Respuesta inesperada del servidor: ' + text);
        }
      } catch (err) {
        alert('Error al borrar archivo: ' + err);
      }
    }

    function appendMessage(sender, text, suggestions = [], ticketOption = false, titulo_sugerido = "") {
      const msgDiv = document.createElement('div');
      msgDiv.className = 'message ' + sender;
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      bubble.textContent = text;
      msgDiv.appendChild(bubble);
      chatbox.appendChild(msgDiv);

      // Sugerencias semánticas
      if (sender === 'bot' && suggestions.length > 0) {
        const sugContainer = document.createElement('div');
        sugContainer.className = 'suggestions';
        suggestions.forEach(s => {
          const btn = document.createElement('div');
          btn.className = 'suggestion';
          btn.textContent = s;
          btn.onclick = () => sendMessage(s);
          sugContainer.appendChild(btn);
        });
        chatbox.appendChild(sugContainer);
      }

      // Botón de crear ticket si no hubo respuesta útil
      if (sender === 'bot' && ticketOption) {
        const ticketBtn = document.createElement('button');
        ticketBtn.textContent = '¿Deseas crear un ticket?';
        ticketBtn.className = 'ticket-btn';
        ticketBtn.onclick = () => showTicketForm(titulo_sugerido);
        chatbox.appendChild(ticketBtn);
      }

      chatbox.scrollTop = chatbox.scrollHeight;
    }


    function showTicketForm(titulo_sugerido = "") {
      input.value = '';

      const formDiv = document.createElement('div');
      formDiv.className = 'ticket-form';

      formDiv.innerHTML = `
    <div class="form-group">
      <label>Nombre:</label>
      <input type="text" id="ticketName" />
    </div>
    <div class="form-group">
      <label>Título:</label>
      <input type="text" id="ticketTitle" value="${titulo_sugerido}" readonly />
    </div>
    <div class="form-group">
      <label>Descripción:</label>
      <input type="text" id="ticketDesc" />
    </div>
    <button onclick="submitTicket()">Enviar ticket</button>
  `;

      chatbox.appendChild(formDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function submitTicket() {
      const nombre = document.getElementById('ticketName').value.trim();
      const titulo = document.getElementById('ticketTitle').value.trim();
      const descripcion = document.getElementById('ticketDesc').value.trim();

      if (!nombre || !titulo || !descripcion) {
        alert('Por favor completa todos los campos.');
        return;
      }

      try {
        const res = await fetch('/crear_ticket', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, titulo, descripcion })
        });

        const data = await res.json();
        appendMessage('bot', data.msg || 'Ticket enviado con éxito.');
      } catch {
        appendMessage('bot', 'Hubo un error al enviar el ticket.');
      }
    }


    // Subida CSV
    const uploadForm = document.getElementById('uploadForm');
    uploadForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById('csvFile');
      if (!fileInput.files.length) {
        alert('Selecciona un archivo CSV primero.');
        return;
      }
      const formData = new FormData();
      formData.append('file', fileInput.files[0]);

      try {
        const res = await fetch('/upload_csv', {
          method: 'POST',
          body: formData
        });
        const text = await res.text();
        alert(text);
        fileInput.value = '';
        loadCSVList();
      } catch {
        alert('Error al subir el archivo.');
      }
    });

    // Cargar lista al inicio
    window.onload = () => {
      loadCSVList();
    };

    function showTicketForm(titulo_sugerido = "") {
      input.value = '';

      const formDiv = document.createElement('div');
      formDiv.className = 'ticket-form';

      formDiv.innerHTML = `
    <div class="form-group">
      <label>Nombre:</label>
      <input type="text" id="ticketName" />
    </div>
    <div class="form-group">
      <label>Título:</label>
      <input type="text" id="ticketTitle" value="${titulo_sugerido}" readonly />
    </div>
    <div class="form-group">
      <label>Descripción:</label>
      <input type="text" id="ticketDesc" />
    </div>
    <button onclick="submitTicket()">Enviar ticket</button>
  `;

      chatbox.appendChild(formDiv);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    async function submitTicket() {
      const nombre = document.getElementById('ticketName').value.trim();
      const titulo = document.getElementById('ticketTitle').value.trim();
      const descripcion = document.getElementById('ticketDesc').value.trim();

      if (!nombre || !titulo || !descripcion) {
        alert('Por favor completa todos los campos.');
        return;
      }

      try {
        const res = await fetch('/crear_ticket', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ nombre, titulo, descripcion })
        });

        const data = await res.json();
        appendMessage('bot', data.msg || 'Ticket enviado con éxito.');
      } catch {
        appendMessage('bot', 'Hubo un error al enviar el ticket.');
      }
    } 
  </script>

</body>

</html>